---
title: "[BETA] TBR 1.39e Item Library"
format:
  html:
    grid:
      sidebar-width: 50px
      body-width: 1500px
      margin-width: 50px
      gutter-width: 1.5rem
    theme: darkly
date: last-modified
editor: source
embed-resources: true
---

<!-- 
To-do: 
- CSS Theme of the Item Library... 
- Table filters
- Table functionality
- Acquisition
-- Purchaseable
-- Other
- Metadata
-->

```{css, echo = FALSE}
.dataTable, .dataTables_wrapper .dataTables_info, label {
  color: white;
}

.dataTables_wrapper .dataTables_length select {
  background-color: rgb(34, 34, 34);
}

.dataTables_wrapper .dataTables_paginate .paginate_button.current, .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover, .dataTables_wrapper .dataTables_paginate .paginate_button.disabled, .dataTables_wrapper .dataTables_paginate .paginate_button {
  color: white !important;
}

.basic-block, .component-block {
  display: flex;
  align-items: center;
  justify-content: left;
  flex-direction: row;
}

.basic-block > div {
  padding: 0 0.5em;
}

.component-block-col {
  display: flex;
  align-items: left;
  justify-content: left;
  flex-direction: column;
}
```

```{r setup}
#| include: false

library(dplyr)
library(jsonlite)
library(DT)
library(tidyr)

# Gold icon path
gold.path <- "https://ucarecdn.com/54aa03b3-111d-4f89-abf8-d4df2ef25ae2/gold.png"
  
# Crafting materials icon path
crafting.materials.path <- "https://ucarecdn.com/50b3eec3-a8b8-4e50-a42c-a7bc38add381/materials.png"
  
# Essence icon path
essence.path <- "https://ucarecdn.com/a22c7029-a47f-409a-89be-4efb7ff5ea40/essence.png"

# Load in raw data
item.data <- read_json("../the-black-road-rpg/map/war3map.w3t.json")$custom
item.wts.data <- read_json("../the-black-road-rpg/map/war3mapSkin.w3t.json")$custom

unit.data <- read_json("../the-black-road-rpg/map/war3map.w3u.json")$custom
unit.wts.data <- read_json("../the-black-road-rpg/map/war3mapSkin.w3u.json")$custom

drop.data <- read.csv("./data/drop-table.csv")

wts.data <- read_json("../the-black-road-rpg/map/war3map.wts.json")

icon.data <- read.csv("./data/icons.csv") |> mutate(icon = gsub(".*/(.*)\\.png", "\\1", path))

crafting.lines <- readLines("../the-black-road-rpg/map/src/50-crafting/Initilization.j") |>
  gsub(pattern = "\t", replacement = "")
forging.lines <- readLines("../the-black-road-rpg/map/src/49-Vendors/Forge Craftmen.j") |>
  gsub(pattern = "\t", replacement = "")
regalia.lines <- readLines("../the-black-road-rpg/map/src/49-Vendors/Forge Regalia.j") |>
  gsub(pattern = "\t", replacement = "")

# Construct spline
df <- tibble(
  rawcode = item.data |> names() |> gsub(pattern = "(I...):.*", replacement = "\\1"),
  parentcode = item.data |> names() |> gsub(pattern = "I...:(.*)", replacement = "\\1")
)

unit.df <- tibble(
  rawcode = unit.data |> names() |> gsub(pattern = "(....):.*", replacement = "\\1"),
  parentcode = unit.data |> names() |> gsub(pattern = "....:(.*)", replacement = "\\1")
)

# Update names for item.*
names(item.data) <- df$rawcode
names(item.wts.data) <- df$rawcode

# Update names for unit.*
names(unit.data) <- unit.df$rawcode
names(unit.wts.data) <- unit.df$rawcode

# Update names for wts.data
names(wts.data) <- paste("TRIGSTR", names(wts.data), sep = "_")

# Build fields from unit.* -----------------------------------------------------
unit.df$name <- sapply(unit.wts.data, \(x) {
  which_index <- sapply(x, \(y) y$id %in% "unam")

  if (any(which_index)) {
    if (!is.null(wts.data[[x[[which(which_index)]]$value]])) {
      return (wts.data[[x[[which(which_index)]]$value]])
    }
  }

  return (NA)
})

unit.df$items.sold <- sapply(unit.data, \(x) {
  which_index <- sapply(x, \(y) y$id %in% "usei")

  if (any(which_index)) {
    if (!is.null(x[[which(which_index)]]$value)) {
      return (x[[which(which_index)]]$value)
    }
  }

  return (NA_character_)
})

# Filter down to shopkeepers
# This is borked?
unit.df <- unit.df |>
  filter(!is.na(items.sold)) |>
  separate_longer_delim(items.sold, delim = ",")

# Build fields for spline ------------------------------------------------------
df$name <- sapply(item.wts.data, \(x) {
  which_index <- sapply(x, \(y) y$id %in% "unam") |> 
    which()

  if (length(which_index) > 0) {
    a <- gsub(
      "\\|r",
      "</span>",
      wts.data[[x[[which_index]]$value]]
    )
    
    return (ifelse(
      grepl("</span>", a), 
      sub(
        "\\|?c?[A-Za-z0-9]?[A-Za-z0-9]?([A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9])",
        "<span style='color: #\\1'>", 
        a
      ), 
      a
    ))
  }
  
  return (NA)
})

df$icon <- sapply(item.wts.data, \(x) {
  which_index <- sapply(x, \(y) y$id %in% "iico") |> 
    which()

  if (length(which_index) > 0) {
    return (gsub(
      "ReplaceableTextures\\\\CommandButtons\\\\(.*)\\.[Bb][Ll][Pp]", 
      "\\1",
      x[[which_index]]$value
    ))
  }
  
  return (NA)
})

df$class <- sapply(item.data, \(x) {
  which_index <- sapply(x, \(y) y$id %in% "icla") |> 
    which()

  if (length(which_index) > 0) {
    return (x[[which_index]]$value)
  }
  
  return (NA)
})

df$level <- sapply(item.data, \(x) {
  which_index <- sapply(x, \(y) y$id %in% "ilev") |> 
    which()

  if (length(which_index) > 0) {
    return (x[[which_index]]$value)
  }
  
  return (NA)
})

df$prio <- sapply(item.data, \(x) {
  which_index <- sapply(x, \(y) y$id %in% "ipri") |> 
    which()

  if (length(which_index) > 0) {
    return (x[[which_index]]$value)
  }
  
  return (NA)
})

df$tooltip <- sapply(item.wts.data, \(x) {
  which_index <- sapply(x, \(y) y$id %in% "utub") |> 
    which()

  if (length(which_index) > 0) {
    a <- sub("(\\|n)*\\|c[A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9]Requires Level [0-9]*\\|r", "", wts.data[[x[[which_index]]$value]]) |>
      gsub("\\|r", "</span>", x = _) |>
      gsub("\\|n", "<br>", x = _)
    
    b <- ifelse(
      grepl("</span>", a), 
      gsub(
        "\\|c[A-Za-z0-9][A-Za-z0-9]([A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9])",
        "<span style='color: #\\1'>",
        a), 
      a
    )
    
    return (sub("(<br>)*<span style='color: #ff0000'>.*</span>", "", x = b) |>
              sub("(<br>)*<span style='color: #fa8072'>.*</span>", "", x = _) |>
              sub("(<br>)*<span style='color: #73C2FB'>.*</span>", "", x = _))
  }
  
  return (NA)
})

df$gold <- sapply(item.data, \(x) {
  which_index <- sapply(x, \(y) y$id %in% "igol") |> 
    which()

  if (length(which_index) > 0) {
    return (x[[which_index]]$value)
  }
  
  return (NA)
})

df$crafting.material <- sapply(item.data, \(x) {
  which_index <- sapply(x, \(y) y$id %in% "ilum") |> 
    which()

  if (length(which_index) > 0) {
    return (x[[which_index]]$value)
  }
  
  return (NA)
})

df$essence <- NA

df <- df |>
  mutate(icon = if_else(is.na(icon), case_match(parentcode,
                                         "rlif" ~ "BTNRingSkull",
                                         "belv" ~ "BTNBoots",
                                         "frhg" ~ "BTNAdvancedUnholyStrength",
                                         "pmna" ~ "BTNPendantOfMana",
                                         "cnob" ~ "BTNCirclet",
                                         "penr" ~ "BTNPendantOfEnergy",
                                         "ckng" ~ "BTNHelmutPurple",
                                         "rat6" ~ "BTNClawsOfAttack",
                                         "shas" ~ "BTNScrollOfHaste",
                                         "stwp" ~ "BTNScrollUber",
                                         "ankh" ~ "BTNAnkh",
                                         "sreg" ~ "BTNScrollOfRegenerationGreen",
                                         "phea" ~ "BTNPotionGreenSmall",
                                         "pman" ~ "BTNPotionBlueSmall",
                                         "shea" ~ "BTNScrollOfTownPortal",
                                         "sman" ~ "BTNScrollOfProtection",
                                         "spro" ~ "BTNScroll",
                                         "sror" ~ "BTNSnazzyScrollGreen",
                                         "wneg" ~ "BTNWandSkull",
                                         "pghe" ~ "BTNPotionGreen",
                                         "pgma" ~ "BTNPotionBlueBig",
                                         "oslo" ~ "BTNOrbofSlowness",
                                         "sehr" ~ "BTNHeartOfSearinox",
                                         "bzbf" ~ "BTNVialFull",
                                         "rhth" ~ "BTNPeriapt1",
                                         "k3m3" ~ "BTN3M3",
                                         "rwiz" ~ "BTNSobiMask",
                                         ), icon),
  icon = if_else(icon == "BTNFrostmourne", "BTNFrostMourne", icon))

# Build fields from regalia.lines ----------------------------------------------
regalia.df <- tibble(
  items.sold = grep(pattern = "set generatorID\\[[0-9]+\\] = '.*'", x = regalia.lines, value = TRUE) |>
    gsub(pattern = "^set generatorID\\[[0-9]+\\] = '(.*)'", x = _, replacement = "\\1"),
  internal.index = grep(pattern = "set generatorID\\[[0-9]+\\] = '.*'", x = regalia.lines, value = TRUE) |>
    gsub(pattern = "^set generatorID\\[([0-9]+)\\] = '.*'", x = _, replacement = "\\1"),

  vendor.div = "<div style=\"height: 25px; margin: auto 0; font-size: 0.9em;\">Master Metalsmith Heletes</div>",
  cost.div = "",
  reg.present.div = ""
)

for (i in 1:6) {
  regalia.df[, paste0("index.", i)] <- sapply(regalia.df$internal.index, \(x) {
    y <- grep(pattern = paste0("^set components\\[", x, " \\* 9 \\+ ", i, "\\]"), x = regalia.lines, value = TRUE) |>
      gsub(pattern = paste0("^set components\\[", x, " \\* 9 \\+ ", i, "\\] = '(.*)'"), x = _, replacement = "\\1")
    
    
    if (x %in% as.character(seq(1, 132, by = 11))) {
      if (i == 1) {
        return ("I00F")
      } else if (i == 2) {
        return ("I00G")
      }
    }
    if (length(y) == 0) return ("")
    
    return (y)
  })
}

regalia.df <- regalia.df |>
  pivot_longer(starts_with("index"), names_to = "index", values_to = "item.req") |>
  left_join(df |> select(rawcode, name, icon), by = join_by(item.req == rawcode)) |>
  left_join(icon.data, by = join_by(icon)) |>
  select(-icon) |>
  pivot_wider(id_cols = c(items.sold:reg.present.div), names_from = index, values_from = c(item.req, name, path), names_sep = ".") |>
  mutate(plain.component.list = paste(name.index.1, name.index.2, name.index.3, name.index.4, name.index.5, name.index.6, sep = "; ") |>
           gsub(pattern = "(<span style='color: #[A-Za-z0-9]+'>|</span>| NA;|; NA|NA)", replacement = "", x = _),
         across(.cols = starts_with("name.index."), ~ if_else(!is.na(.x), gsub(pattern = "(<span style='color: #[A-Za-z0-9]+'>|</span>)", replacement = "", x = .x), ""), .names = "{.col}.plain"))

for (i in 1:nrow(regalia.df)) {
  essence <- grep(pattern = paste0("set components\\[", regalia.df$internal.index[i], " \\* 9 \\+ 7\\]"), x = regalia.lines, value = TRUE) |>
    gsub(pattern = paste0("set components\\[", regalia.df$internal.index[i], " \\* 9 \\+ 7\\] = ([0-9]+)"), x = _, replacement = "\\1")
  
  req.level <- grep(pattern = paste0("set components\\[", regalia.df$internal.index[i], " \\* 9 \\+ 8\\]"), x = regalia.lines, value = TRUE) |>
    gsub(pattern = paste0("set components\\[", regalia.df$internal.index[i], " \\* 9 \\+ 8\\] = ([0-9]+)"), x = _, replacement = "\\1")
  
  regalia.df$cost.div[i] <- if_else(length(essence) == 0, "", paste0("<div class=\"component-block\" style=\"height: 25px;\"><div style=\"height: 100%;\"><img src=\"", essence.path, "\" style=\"width: 25px; vertical-align: unset; height: 25px;\"/></div><div style=\"margin: auto 0.25em; font-size: 0.9em;\">", essence, "</div></div>"))
}

regalia.df$component.div <- "<div class=\"component-block\" style=\"height: 25px;\"><div style=\"margin: auto 0; font-size: 0.9em;\">Components:&nbsp;</div>"

for (index in 1:6) {
  i <- paste0("path.index.", index)
  for (j in 1:nrow(regalia.df)) {
    regalia.df$component.div[j] <- paste0(regalia.df$component.div[j], if_else(!is.na(regalia.df[j, i]), paste0("<div style=\"height: 100%;\"><img src=\"", regalia.df[j, i], "\" title=\"", regalia.df[j, paste0("name.index.", index, ".plain")], "\" style=\"width: 25px; vertical-align: unset; height: 25px;\"//></div>"), ""))
  }
}

regalia.df$reg.present.div <- paste0("<div class=\"component-block-col\" style=\"min-width: 200px;\">", regalia.df$vendor.div, regalia.df$cost.div, regalia.df$component.div, "</div>")

# Build fields from crafting.lines ---------------------------------------------
x <- grep(pattern = "set udg_zNewCraftingXPreq\\[[0-9]+\\]=.*", x = crafting.lines, value = TRUE) |>
  gsub(pattern = "^set udg_zNewCraftingXPreq\\[[0-9]+\\]=(.*)", x = _, replacement = "\\1")

crafting.df <- tibble(
  vendor = "",
  items.sold = grep(pattern = "set udg_zNewCraftingItem\\[[0-9]+\\]='.*'", x = crafting.lines, value = TRUE) |>
    gsub(pattern = "^set udg_zNewCraftingItem\\[[0-9]+\\]='(.*)'", x = _, replacement = "\\1"),
  craft.level = x[x != "101"] |> as.numeric(),
  craft.mats = grep(pattern = "set udg_zNewCraftingMats\\[[0-9]+\\]=.*", x = crafting.lines, value = TRUE) |>
    gsub(pattern = "^set udg_zNewCraftingMats\\[[0-9]+\\]=(.*)", x = _, replacement = "\\1"),
  internal.index = grep(pattern = "set udg_zNewCraftingItem\\[[0-9]+\\]='.*'", x = crafting.lines, value = TRUE) |>
    gsub(pattern = "^set udg_zNewCraftingItem\\[([0-9]+)\\]='.*'", x = _, replacement = "\\1") |>
    as.numeric()) |>
  mutate(craft.profession = case_when(between(internal.index, 0, 59) ~ "Weaponsmith",
                                      between(internal.index, 60, 119) ~ "Armorsmith",
                                      between(internal.index, 120, 179) ~ "Alchemist",
                                      between(internal.index, 180, 239) ~ "Goldsmith"),
         vendor = paste0(craft.profession, " &mdash; Level ", craft.level))

for (i in 1:8) {
  crafting.df[, paste0("index.", i)] <- sapply(crafting.df$internal.index, \(x) {
    y <- grep(pattern = paste0("set udg_zNewCraftingReq", i, "\\[", x, "\\]='.*'"), x = crafting.lines, value = TRUE) |>
      gsub(pattern = paste0("set udg_zNewCraftingReq", i, "\\[", x, "\\]='(.*)'"), x = _, replacement = "\\1")
    
    if (length(y) == 0) return ("")
    
    return (y)
  })
}

crafting.df <- crafting.df |>
  pivot_longer(starts_with("index"), names_to = "index", values_to = "item.req") |>
  left_join(df |> select(rawcode, name, icon), by = join_by(item.req == rawcode)) |>
  left_join(icon.data, by = join_by(icon)) |>
  select(-icon) |>
  pivot_wider(id_cols = c(vendor:internal.index), names_from = index, values_from = c(item.req, name, path), names_sep = ".") |> 
  mutate(plain.component.list = paste(name.index.1, name.index.2, name.index.3, name.index.4, name.index.5, name.index.6, name.index.7, name.index.8, sep = "; ") |>
           gsub(pattern = "(<span style='color: #[A-Za-z0-9]+'>|</span>| NA;|; NA|NA)", replacement = "", x = _),
         across(.cols = starts_with("name.index."), ~ if_else(!is.na(.x), gsub(pattern = "(<span style='color: #[A-Za-z0-9]+'>|</span>)", replacement = "", x = .x), ""), .names = "{.col}.plain"),
         materials.div = paste0("<div class=\"component-block\" style=\"height: 25px;\"><div style=\"height: 100%;\"><img src=\"", crafting.materials.path, "\" style=\"width: 25px; vertical-align: unset; height: 25px;\"/></div><div style=\"margin: auto 0.25em; font-size: 0.9em;\">", craft.mats, "</div></div>"))

crafting.df$component.div <- if_else(crafting.df$plain.component.list != "", "<div class=\"component-block\" style=\"height: 25px;\"><div style=\"margin: auto 0; font-size: 0.9em;\">Components:&nbsp;</div>", "") 
for (index in 1:8) {
  i <- paste0("path.index.", index)
  for (j in 1:nrow(crafting.df)) {
    crafting.df$component.div[j] <- paste0(crafting.df$component.div[j], if_else(!is.na(crafting.df[j, i]), paste0("<div style=\"height: 100%;\"><img src=\"", crafting.df[j, i], "\" title=\"", crafting.df[j, paste0("name.index.", index, ".plain")], "\" style=\"width: 25px; vertical-align: unset; height: 25px;\"//></div>"), ""))
  }
}

for (i in 1:nrow(crafting.df)) {
  crafting.df$component.div[i] <- if_else(crafting.df$plain.component.list[i] != "", paste0(crafting.df$component.div[i], "</div>"), "") 
}

crafting.df$present.div <- paste0("<div class=\"component-block-col\"><div style=\"height: 25px; margin: auto 0; font-size: 0.9em;\">", crafting.df$vendor, "</div>", crafting.df$materials.div, crafting.df$component.div, "</div>")

# Build fields from forging.lines ---------------------------------------------

forge.df <- unit.df |> 
  select(name, items.sold) |>
  rename(vendor = name) |>
  left_join(df |> select(rawcode, name) |> rename(item.name = name), by = join_by(items.sold == rawcode)) |>
  mutate(forge.flag = grepl("^Forge", item.name),
         item.name = if_else(forge.flag, gsub(pattern = "Forge (.*)", replacement = "\\1", x = item.name), item.name)) |>
  filter(forge.flag) %>%
  left_join(df |> select(rawcode, name) |> rename(forge.link = rawcode) |> filter(name %in% .$item.name), by = join_by(item.name == name))

forge.spline <- tibble(.rows = nrow(forge.df))
forge.spline$internal.index <- grep(pattern = "set components\\[[0-9]+ \\* 16 \\+ 15\\]", x = forging.lines, value = TRUE) |>
    gsub(pattern = "^set components\\[([0-9]+) \\* 16 \\+ 15\\] = '.*'", x = _, replacement = "\\1")
forge.spline$rawcode <- grep(pattern = "set components\\[[0-9]+ \\* 16 \\+ 15\\]", x = forging.lines, value = TRUE) |>
    gsub(pattern = "^set components\\[[0-9]+ \\* 16 \\+ 15\\] = '(.*)'", x = _, replacement = "\\1")

forge.df <- forge.df |>
  left_join(forge.spline, by = join_by(forge.link == rawcode))

forge.df$gold <- sapply(forge.df$internal.index, \(index) {
  x <- grep(pattern = paste0("set components\\[", index, " \\* 16 \\+ 13\\]"), x = forging.lines, value = TRUE) |>
    gsub(pattern = paste0("^set components\\[", index, " \\* 16 \\+ 13\\] = (.*)"), x = _, replacement = "\\1")
  
  if (length(x) == 0) return ("")
  
  return (x)
})

forge.df$crafting.mats <- sapply(forge.df$internal.index, \(index) {
  x <- grep(pattern = paste0("set components\\[", index, " \\* 16 \\+ 14\\]"), x = forging.lines, value = TRUE) |>
    gsub(pattern = paste0("^set components\\[", index, " \\* 16 \\+ 14\\] = (.*)"), x = _, replacement = "\\1")
  
  if (length(x) == 0) return ("")
  
  return (x)
})

for (i in 0:11) {
  forge.df[, paste0("index.", i)] <- sapply(forge.df$internal.index, \(x) {
    y <- grep(pattern = paste0("^set components\\[", x, " \\* 16 \\+ ", i, "\\]"), x = forging.lines, value = TRUE) |>
      gsub(pattern = paste0("^set components\\[", x, " \\* 16 \\+ ", i, "\\] = '(.*)' //.*"), x = _, replacement = "\\1")
    
    if (length(y) == 0) return ("")
    
    return (y)
  })
}

forge.df <- forge.df |>
  pivot_longer(starts_with("index"), names_to = "index", values_to = "item.req") |>
  left_join(df |> select(rawcode, name, icon), by = join_by(item.req == rawcode)) |>
  left_join(icon.data, by = join_by(icon)) |>
  select(-icon) |>
  pivot_wider(id_cols = c(vendor:crafting.mats), names_from = index, values_from = c(item.req, name, path), names_sep = ".") |>
  mutate(plain.component.list = paste(name.index.0, name.index.1, name.index.2, name.index.3, name.index.4, name.index.5, name.index.6, name.index.7, name.index.8, name.index.9, name.index.10, name.index.11, sep = "; ") |>
           gsub(pattern = "(<span style='color: #[A-Za-z0-9]+'>|</span>| NA;|; NA|NA)", replacement = "", x = _),
         across(.cols = starts_with("name.index."), ~ if_else(!is.na(.x), gsub(pattern = "(<span style='color: #[A-Za-z0-9]+'>|</span>)", replacement = "", x = .x), ""), .names = "{.col}.plain"),
         vendor.div = paste0("<div style=\"height: 25px; margin: auto 0; font-size: 0.9em;\">", vendor, "</div>"))

forge.df$cost.div <- sapply(1:nrow(forge.df), \(index) {
  check.gold <- forge.df$gold[index] != ""
  check.crafting.materials <- forge.df$crafting.mats[index] != ""
  
  if (!check.gold & !check.crafting.materials) return ("")
  if (check.gold & check.crafting.materials) return (paste0("<div class=\"component-block\" style=\"height: 25px;\"><div style=\"height: 100%;\"><img src=\"", gold.path, "\" style=\"width: 25px; vertical-align: unset; height: 25px;\"/></div><div style=\"margin: auto 0.25em; font-size: 0.9em;\">", forge.df$gold[index], "</div><div style=\"height: 100%;\"><img src=\"", crafting.materials.path, "\" style=\"width: 25px; vertical-align: unset; height: 25px;\"/></div><div style=\"margin: auto 0.25em; font-size: 0.9em;\">", forge.df$crafting.mats[index], "</div></div>"))
})

forge.df$component.div <- "<div class=\"component-block\" style=\"height: 25px;\"><div style=\"margin: auto 0; font-size: 0.9em;\">Components:&nbsp;</div>"

for (index in 0:11) {
  i <- paste0("path.index.", index)
  for (j in 1:nrow(forge.df)) {
    forge.df$component.div[j] <- paste0(forge.df$component.div[j], if_else(!is.na(forge.df[j, i]), paste0("<div style=\"height: 100%;\"><img src=\"", forge.df[j, i], "\" title=\"", forge.df[j, paste0("name.index.", index, ".plain")], "\" style=\"width: 25px; vertical-align: unset; height: 25px;\"//></div>"), ""))
  }
}

forge.df$forge.present.div <- paste0("<div class=\"component-block-col\" style=\"min-width: 200px;\">", forge.df$vendor.div, forge.df$cost.div, forge.df$component.div,  "</div>")

# All other formatted info ------------------------------------------------

other.df <- unit.df |> 
  select(name, items.sold) |>
  rename(vendor = name) |> 
  bind_rows(drop.data |> select(source, item.rawcode) |> rename(items.sold = item.rawcode, vendor = source)) |>
  left_join(df |> select(rawcode, name) |> rename(item.name = name), by = join_by(items.sold == rawcode)) |>
  mutate(forge.flag = grepl("^Forge", item.name),
         item.name = if_else(forge.flag, gsub(pattern = "Forge (.*)", replacement = "\\1", x = item.name), item.name)) |>
  filter(!forge.flag) |>
  chop(vendor)

other.df$vendor <- sapply(other.df$vendor, paste, collapse = "; ")

# Hard-coded updates to item.df ------------------------------------------------

item.df <- df |> mutate(
  class = if_else(is.na(class), case_match(parentcode,
                                           c("kymn", "kybl", "azhr", "sehr", "kygh", "bzbf") ~ "Campaign",
                                           c("rwiz", "evtl", "rlif", "mcou", "penr", "rat6", "pmna", "rde1", "rhth", "bgst", "belv", "cnob", "clsd", "ciri") ~ "Permanent",
                                           c("sreg", "k3m3", "wneg", "phea", "pman", "shea", "spro", "stwp", "shas", "sman") ~ "Purchasable",
                                           c("rnsp", "oslo", "frhg") ~ "Miscellaneous",
                                           c("ckng", "desc") ~ "Artifact",
                                           c("ankh", "pghe", "pgma", "sror", "rej3") ~ "Charged",
                                           c("rres", "gold", "lmbr") ~ "PowerUp"), class),
  name = if_else(is.na(name), case_match(parentcode,
                                         "kymn" ~ "Moon Key",
                                         "cnob" ~ "Circlet of Nobility",
                                         "frhg" ~ "Firehand Gauntlets",
                                         "rres" ~ "Rune of Restoration",
                                         "gold" ~ "Gold Coins"), name),
  prio = if_else(!is.na(prio), case_match(prio,
                                          1 ~ "Forge Dummy",
                                          1001 ~ "Cannot be used by Warrior classes",
                                          1002 ~ "Khaos Champion, Barbarian, Warlord, Assassin only",
                                          1003 ~ "Barbarian Only",
                                          1004 ~ "Warlord Only",
                                          1005 ~ "Temple Guardian Only",
                                          1006 ~ "Ranger Only",
                                          1007 ~ "Khaos Champion Only",
                                          1008 ~ "Cleric only",
                                          1009 ~ "Assassin only",
                                          1010 ~ "Magician only",
                                          1011 ~ "Warlock only",
                                          1012 ~ "Guardian of Nature only",
                                          1013 ~ "Spartan Warrior only",
                                          1014 ~ "Druid only"
                                          ), NA_character_),
  level = as.numeric(level),
  level = if_else(is.na(level), case_match(parentcode,
                                            "rlif" ~ 3,
                                            "mcou" ~ 5,
                                            "rej3" ~ 2,
                                            c("kymn", "kybl") ~ 0),
                  level),
  rarity = case_when(grepl("#00ffff", name) ~ "Uncommon",
                     grepl("#fa8072", name) ~ "Consumables",
                     grepl("#ff7700", name) ~ "Rare",
                     grepl("#ffdead", name) ~ "Artifact",
                     grepl("#32cd32", name) ~ "Epic",
                     grepl("#A1045A", name) ~ "Regalia",
                     grepl("#1E90FF", name) ~ "Relic / Olympian Relic",
                     grepl("#73C2FB", name) ~ "Crafting Component / Unique Crafting Component",
                     .default = "Common"),
  name.clean = gsub("(</span>)|(<span style='color: #.*'>)", "", name)) |>
  left_join(y = icon.data, by = join_by(icon)) |>
  left_join(y = other.df, by = join_by(rawcode == items.sold)) |>
  left_join(y = crafting.df |> select(items.sold, present.div), by = join_by(rawcode == items.sold)) |>
  left_join(y = forge.df |> select(forge.link, forge.present.div), by = join_by(rawcode == forge.link)) |>
  left_join(y = regalia.df |> select(items.sold, reg.present.div), by = join_by(rawcode == items.sold))
```

```{r display_items}
#| echo: false

item.cleaned.df <- item.df |>
  filter(class != "PowerUp",
         class != "Campaign",
         name.clean != "Rune of Restoration",
         !grepl("Tome of Attribute Increase", name.clean),
         name.clean != "Iron Key",
         !rawcode %in% c("I0EX", "I0EY")
         ) |>
  mutate(
    rarity = factor(rarity, levels = c("Common", "Uncommon", "Consumables", "Crafting Component / Unique Crafting Component", "Rare", "Artifact", "Epic", "Relic / Olympian Relic", "Regalia"), ordered = TRUE)) |>
  arrange(rarity, level, name.clean)

item.cleaned.df |>
  select(name, path, level, rarity, tooltip, prio, vendor) |>
  rename(restriction = prio, acquisition = vendor) |>
  rowwise() |>
  mutate(tooltip = unlist(tooltip)) |>
  write.csv("./data/item_data.csv", row.names = FALSE)

item.cleaned.df |>
  mutate(name.aug = paste0(name,
                           if_else(level > 0, paste0("<br><span style='color: #ffcc00;'>Requires Level ", level, "</span>"), ""),
                           if_else(!is.na(prio), paste0("<br><span style='color: #ff0000;'>", prio, "</span>"), "")),
         icon.block = paste0("<img src=\"", path, "\"/>"),
         basic.block = paste0("<div class=\"basic-block\"><div>", icon.block, "</div><div>", name.aug, "</div>")) |>
  mutate(vendor = paste0("<div><div>", if_else(!is.na(vendor), vendor, ""), "</div>", if_else(!is.na(forge.present.div), forge.present.div, ""), if_else(!is.na(reg.present.div), reg.present.div, ""), if_else(!is.na(present.div), present.div, ""), "</div>") ,
         present.div = NULL) |>
  select(basic.block, tooltip, vendor) |>
  datatable(
    rownames = FALSE, 
    escape = FALSE, 
    colnames = c("Item", "Description", "Acquisition"),
    options = list(columnDefs = list(list(width = "400px", targets = 0)))
  )
```